---
import AppLayout from "@/layouts/AppLayout.astro";
import MediaHeader from "@/components/media/MediaHeader.vue";
import { Button } from "@/components/ui/button";
import { MediaType } from "@/lib/constants";

const { type, id } = Astro.params;

if (!type || !id || (type !== MediaType.MOVIE && type !== MediaType.TV)) {
    return Astro.redirect("/404");
}

let mediaItem = null;
let error = null;

try {
    const apiUrl = new URL(`/api/media/${type}/${id}`, Astro.url.origin);
    const res = await fetch(apiUrl);

    if (res.ok) {
        mediaItem = await res.json();
        // Inject type into the item for the component to use
        mediaItem.type = type;
    } else {
        error = `Failed to load ${type}`;
    }
} catch (e) {
    error = "An error occurred";
    console.error(e);
}
---

<AppLayout>
    <main class="min-h-screen pb-20">
        {
            error ? (
                <div class="max-w-7xl mx-auto px-4 py-20 text-center">
                    <h1 class="text-2xl font-bold text-destructive mb-4">
                        Error Loading Media
                    </h1>
                    <p class="text-muted-foreground">{error}</p>
                    <Button
                        as="a"
                        href="/search"
                        variant="link"
                        class="mt-8 text-primary hover:text-primary/80"
                    >
                        Back to Search
                    </Button>
                </div>
            ) : mediaItem ? (
                <>
                    <MediaHeader client:load media={mediaItem} />

                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    </div>
                </>
            ) : (
                <div class="flex items-center justify-center min-h-[50vh]">
                    <div class="animate-pulse text-muted-foreground">Loading...</div>
                </div>
            )
        }
    </main>
</AppLayout>
