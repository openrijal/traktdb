---
import Layout from "../layouts/Layout.astro";
import MediaGrid from "@/components/media/MediaGrid.vue";
import MediaCard from "@/components/media/MediaCard.vue";
import { db } from "@/lib/db";
import { mediaItems, userProgress } from "drizzle/schema";
import { eq, desc, and } from "drizzle-orm";
import { auth } from "@/lib/auth";
import {
    WatchStatus,
    WatchStatusLabels,
    MediaType,
    LibraryTabs,
} from "@/lib/constants";

const session = await auth.api.getSession({ headers: Astro.request.headers });
if (!session) {
    return Astro.redirect("/login");
}

// Fetch user library directly from DB
const rawItems = await db
    .select({
        progress: userProgress,
        media: mediaItems,
    })
    .from(userProgress)
    .innerJoin(mediaItems, eq(userProgress.mediaItemId, mediaItems.id))
    .where(eq(userProgress.userId, session.user.id))
    .orderBy(desc(userProgress.updatedAt));

const watchlist = rawItems
    .filter((i) => i.progress.status === WatchStatus.PLAN_TO_WATCH)
    .map((i) => ({
        ...i.media,
        id: i.media.tmdbId,
        media_type: i.media.type,
        poster_path: i.media.posterPath,
        vote_average: i.media.voteAverage || 0,
        release_date: i.media.releaseDate || undefined,
        first_air_date: i.media.releaseDate || undefined,
    }));
const completed = rawItems
    .filter((i) => i.progress.status === WatchStatus.COMPLETED)
    .map((i) => ({
        ...i.media,
        id: i.media.tmdbId,
        media_type: i.media.type,
        poster_path: i.media.posterPath,
        vote_average: i.media.voteAverage || 0,
        release_date: i.media.releaseDate || undefined,
        first_air_date: i.media.releaseDate || undefined,
    }));
// ... other statuses

const currentTab = Astro.url.searchParams.get("tab") || LibraryTabs.WATCHLIST;
const displayItems = currentTab === LibraryTabs.WATCHED ? completed : watchlist;
---

<Layout title="My Library">
    <main class="min-h-screen bg-gray-950 text-white pb-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">My Library</h1>

            <!-- Tabs -->
            <div class="flex gap-4 border-b border-white/10 mb-8">
                <a
                    href={`/library?tab=${LibraryTabs.WATCHLIST}`}
                    class={`pb-4 px-2 font-medium transition-colors ${currentTab === LibraryTabs.WATCHLIST ? "text-indigo-400 border-b-2 border-indigo-400" : "text-gray-400 hover:text-white"}`}
                >
                    {WatchStatusLabels[WatchStatus.PLAN_TO_WATCH]} ({
                        watchlist.length
                    })
                </a>
                <a
                    href={`/library?tab=${LibraryTabs.WATCHED}`}
                    class={`pb-4 px-2 font-medium transition-colors ${currentTab === LibraryTabs.WATCHED ? "text-indigo-400 border-b-2 border-indigo-400" : "text-gray-400 hover:text-white"}`}
                >
                    {WatchStatusLabels[WatchStatus.COMPLETED]} ({
                        completed.length
                    })
                </a>
            </div>

            <!-- Grid -->
            {
                displayItems.length > 0 ? (
                    <MediaGrid>
                        {displayItems.map((item) => (
                            <MediaCard
                                client:visible
                                media={item}
                                type={item.type as "movie" | "tv"}
                            />
                        ))}
                    </MediaGrid>
                ) : (
                    <div class="text-center py-20 text-gray-500">
                        <p class="text-lg">
                            No items found in No items found in{" "}
                            {currentTab === LibraryTabs.WATCHLIST
                                ? "your watchlist"
                                : "watched history"}
                            .
                        </p>
                        <a
                            href="/search"
                            class="text-indigo-400 hover:underline mt-2 inline-block"
                        >
                            Find something to watch
                        </a>
                    </div>
                )
            }
        </div>
    </main>
</Layout>
