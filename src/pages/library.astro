---
import AppLayout from "@/layouts/AppLayout.astro";
import MediaGrid from "@/components/media/MediaGrid.vue";
import MediaCard from "@/components/media/MediaCard.vue";
import { createDb } from "@/lib/db";
import { mediaItems, userProgress } from "drizzle/schema";
import { eq, desc, and } from "drizzle-orm";
import { createAuth } from "@/lib/auth";
import {
    WatchStatus,
    WatchStatusLabels,
    MediaType,
    LibraryTabs,
    LibraryUI,
} from "@/lib/constants";
import { Button } from "@/components/ui/button";

const env = Astro.locals.runtime?.env || import.meta.env;
const auth = createAuth(env);
const db = createDb(env);

const session = await auth.api.getSession({ headers: Astro.request.headers });
if (!session) {
    return Astro.redirect("/login");
}

// Fetch user library directly from DB
const rawItems = await db
    .select({
        progress: userProgress,
        media: mediaItems,
    })
    .from(userProgress)
    .innerJoin(mediaItems, eq(userProgress.mediaItemId, mediaItems.id))
    .where(eq(userProgress.userId, session.user.id))
    .orderBy(desc(userProgress.updatedAt));

const watchlist = rawItems
    .filter((i) => i.progress.status === WatchStatus.PLAN_TO_WATCH)
    .map((i) => ({
        ...i.media,
        id: i.media.tmdbId,
        media_type: i.media.type,
        poster_path: i.media.posterPath,
        vote_average: i.media.voteAverage || 0,
        release_date: i.media.releaseDate || undefined,
        first_air_date: i.media.releaseDate || undefined,
        last_air_date: i.media.lastAirDate || undefined,
        lastAirDate: i.media.lastAirDate || undefined,
    }));
const completed = rawItems
    .filter((i) => i.progress.status === WatchStatus.COMPLETED)
    .map((i) => ({
        ...i.media,
        id: i.media.tmdbId,
        media_type: i.media.type,
        poster_path: i.media.posterPath,
        vote_average: i.media.voteAverage || 0,
        release_date: i.media.releaseDate || undefined,
        first_air_date: i.media.releaseDate || undefined,
        last_air_date: i.media.lastAirDate || undefined,
        lastAirDate: i.media.lastAirDate || undefined,
    }));
// ... other statuses

const currentTab = Astro.url.searchParams.get("tab") || LibraryTabs.WATCHLIST;
const displayItems = currentTab === LibraryTabs.WATCHED ? completed : watchlist;
---

<AppLayout>
    <main class="min-h-screen bg-gray-950 text-white pb-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">My Library</h1>

            <!-- Tabs -->
            <!-- Tabs -->
            <div class="flex gap-4 mb-8">
                <Button
                    as="a"
                    href={`/library?tab=${LibraryTabs.WATCHLIST}`}
                    variant={currentTab === LibraryTabs.WATCHLIST
                        ? "default"
                        : "ghost"}
                    class="rounded-full"
                >
                    {WatchStatusLabels[WatchStatus.PLAN_TO_WATCH]} ({
                        watchlist.length
                    })
                </Button>
                <Button
                    as="a"
                    href={`/library?tab=${LibraryTabs.WATCHED}`}
                    variant={currentTab === LibraryTabs.WATCHED
                        ? "default"
                        : "ghost"}
                    class="rounded-full"
                >
                    {WatchStatusLabels[WatchStatus.COMPLETED]} ({
                        completed.length
                    })
                </Button>
            </div>

            <!-- Grid -->
            {
                displayItems.length > 0 ? (
                    <MediaGrid>
                        {displayItems.map((item) => (
                            <MediaCard
                                client:visible
                                media={item}
                                type={item.type as MediaType}
                            />
                        ))}
                    </MediaGrid>
                ) : (
                    <div class="text-center py-20 text-gray-500">
                        <p class="text-lg">
                            {LibraryUI.NO_ITEMS_FOUND}{" "}
                            {currentTab === LibraryTabs.WATCHLIST
                                ? LibraryUI.WATCHLIST_EMPTY
                                : LibraryUI.WATCHED_EMPTY}
                            .
                        </p>
                        <a
                            href="/search"
                            class="text-indigo-400 hover:underline mt-2 inline-block"
                        >
                            {LibraryUI.FIND_SOMETHING}
                        </a>
                    </div>
                )
            }
        </div>
    </main>
</AppLayout>
